---

- name: Cleaning host list...
  set_fact:
    published_etc_hosts: {}
    key_list: []
    parsed_value_list: []
    template_value_list: []

- name: Crating temporary expansion template file...
  tempfile:
    state: file
    suffix: temp
  check_mode: no
  register: tempfile_template

- name: Crating temporary expansion result file...
  tempfile:
    state: file
    suffix: temp
  check_mode: no
  register: tempfile_result

- name: Spliting host map into keys and values...
  set_fact:
    key_list: "{{ key_list + [item.key] }}"
    template_value_list: "{{ template_value_list + [item.value] }}"
  with_dict: "{{ (global_etc_hosts | default({})) | combine (service_group_etc_hosts | default({})) | combine (service_etc_hosts | default({})) }}"

- name: Converting list into template...
  lineinfile:
    path: "{{ tempfile_template.path }}"
    line: "{{ item }}"
    regexp: ^$
  with_items: "{{ template_value_list }}"
  check_mode: no

- name: Processing list parameters...
  template:
    src: "{{ tempfile_template.path }}"
    dest: "{{ tempfile_result.path }}"
  check_mode: no

- name: Expanding hosts list...
  set_fact:
    parsed_value_list :  "{{ (item | length > 0) | ternary(item.split('\n'),[])  }}"
  with_file: "{{ tempfile_result.path }}"

- name: Preparing final list...
  set_fact:
    published_etc_hosts: '{{ published_etc_hosts|combine({item[0]: item[1]}) }}'
  with_together:
    - "{{ key_list }}"
    - "{{ parsed_value_list }}"

- name: Removing temporary expansion files...
  file:
    path: '{{ item }}'
    state: absent
  with_items:
    - "{{ tempfile_template.path }}"
    - "{{ tempfile_result.path }}"
  check_mode: no
