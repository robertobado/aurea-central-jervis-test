#!groovy
pipeline {
    agent {
        label 'stable && docker && linux && ansible'
    }
    stages {
        stage('Build Docker Images') {
            steps {
                unstash 'artifacts'
                withCredentials([usernameColonPassword(credentialsId: 'ansible-vault-password', passwordVariable: 'ANSIBLE_VAULT_PASSWORD')]) {
                    sh 'echo "$ANSIBLE_VAULT_PASSWORD" > .ansible-vault-password'
                }
                sh 'ansible-playbook aurea-central-jervis/ansible/jervis.yml -i .inventory --tags docker-image-build --vault-password-file=.ansible-vault-password'
            }
        }
        stage('Docker Service Deploy') {
            steps {
                unstash 'artifacts'
                withCredentials([usernameColonPassword(credentialsId: 'ansible-vault-password', passwordVariable: 'ANSIBLE_VAULT_PASSWORD')]) {
                    sh 'echo "$ANSIBLE_VAULT_PASSWORD" > .ansible-vault-password'
                }
                sh 'ansible-playbook aurea-central-jervis/ansible/jervis.yml -i .inventory --tags docker-service-deploy --vault-password-file=.ansible-vault-password'
            }
        }
    }
}
